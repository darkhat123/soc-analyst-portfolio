# Scenario
The focus of this hands on lab will be an APT scenario and a ransomware scenario. You assume the persona of Alice Bluebird, the soc analyst who has recently been hired to protect and defend Wayne Enterprises against various forms of cyberattack.

Today is Alice's first day at the Wayne Enterprises' Security Operations Center. Lucius sits Alice down and gives her first assignment: A memo from Gotham City Police Department (GCPD). Apparently GCPD has found evidence online (http://pastebin.com/Gw6dWjS9) that the website www.imreallynotbatman.com hosted on Wayne Enterprises' IP address space has been compromised. The group has multiple objectives... but a key aspect of their modus operandi is to deface websites in order to embarrass their victim. Lucius has asked Alice to determine if www.imreallynotbatman.com. (the personal blog of Wayne Corporations CEO) was really compromised.

In this scenario, reports of the below graphic come in from your user community when they visit the Wayne Enterprises website, and some of the reports reference "P01s0n1vy." In case you are unaware, P01s0n1vy is an APT group that has targeted Wayne Enterprises. Your goal, as Alice, is to investigate the defacement, with an eye towards reconstructing the attack via the Lockheed Martin Kill Chain.

## Question 1: Web Defacement: What content management system is imreallynotbatman.com likely using? (Please do not include punctuation such as . , ! ? in your answer. We are looking for alpha characters only.)
Finding out what CMS is available for "imreallynotbatman.com" is as simple as looking at the http logs and searching for the phrase, we can pass the results to a table and display the uri and request for all matches, which
may include the CMS directories

Screenshot: <img width="1915" height="880" alt="image" src="https://github.com/user-attachments/assets/af4c2a76-30ae-475c-8738-8688c59c7251" />

Answer: joomla

## Question 2: Web Defacement: What is the likely IP address of someone from the Po1s0n1vy group scanning imreallynotbatman.com for web application vulnerabilities?

We know that when an attacker scans a website for vulnerabilities they will typically use automated tools, these tools while proficient in identifying known vulnerabilities make alot of noise with the number of requests sent
to the server from one single IP. Sometimes the user-agent or other headers can identify the scanner being used, but to simply identify a flood of traffic from a single ip we can filter through the logs and count the occurences
of all src_ips and identify anomalies such as external ips and large number of requests.

When identifying traffic of interest we can look in the suricata IDS logs which stores any of the traffic captured on the IDS interface, suricata logs all http requests it sees, we can use the metdata generated by suricata 
for all http events to filter for our victim domain and count the number of occurences of a source IP in the HTTP traffic. The one with the highest records is likely the attacker ip.

Query:`index=botsv1 sourcetype=suricata http.hostname="imreallynotbatman.com" | table src_ip| stats count by src_ip | sort -count reverse`
Screenshot: <img width="1914" height="924" alt="image" src="https://github.com/user-attachments/assets/c6a92804-f6ce-43fb-84fd-549aff0a43b7" />

Now we have the IP we can drill into the data and try to present finding of vulnerability scanning

Common indicators of vulnerability scanning include:
- Different source ports connecting to one server
- Different user-agents from the one computer
- Strange URI's and request methods

Query: `index="botsv1" sourcetype="suricata" http.hostname="imreallynotbatman.com" src_ip=40.80.148.42 | table  src_ip http_user_agent, src_port, dest_port`

Answer: 40.80.148.42

## Question 3: Web Defacement: What company created the web vulnerability scanner used by Po1s0n1vy? Type the company name. (For example, "Microsoft" or "Oracle")
Looking through the logs in suricata can again be fruitful to determine the vulnerability scanner being used. Sometimes the vulnerability scanner can trigger an alert when it identifies traffic indicative of an attack
We can look through all of suricatas logs for any alerts logged for the imreallynotbatman.com host, and look for occurrences of the word scan.

Query: `index="botsv1" sourcetype="suricata" "*imreallynotbatman.com*" alert.signature=*  "http.hostname"="imreallynotbatman.com" scan | table  alert.signature`
<img width="1882" height="847" alt="image" src="https://github.com/user-attachments/assets/a470ad48-d646-453c-b109-5c3620f7ad8f" />

This returns a few alert results related to scanning and the answer becomes clear

Answer: acunetix

## Question 4: Web Defacement: What IP address is likely attempting a brute force password attack against imreallynotbatman.com?

When a brute force attack takes place on a website, the most common method of transmitting credentials to be authenticated so that a user can be authorised to do certain actions involves sending a POST request to the server through a form submission. We know that the form likely includes a prompt for password or that the phrase login would likely show up, conducting some research we know that the joomla login is handled by the "/joomla/administrator/index.php" path. With all of this knowledge we can count the number of requests made by each src_ip and determine the culrpit via spikes in traffic to this path

Query:`index="botsv1" sourcetype="stream:http"  "*imreallynotbatman.com*" uri="/joomla/Administrator/index.php" dest_ip="192.168.250.70"
| table src_ip, dest_ip, uri 
| stats count by src_ip`

Screnshot: <img width="1909" height="901" alt="image" src="https://github.com/user-attachments/assets/16f4fb55-c1eb-48e3-98fa-0a97a7d916d8" />

Answer: 23.22.63.114

## Question 5 Web Defacement: What was the first brute force password used?

We know that in order for the attacker to attempt a password they must submit a form, we can access the form_data field and use it to identify records where this is present and then display the form data being saubmitted
starting with the earliest record.

Query: `index="botsv1" sourcetype="stream:http"  "*imreallynotbatman.com*" uri="/joomla/Administrator/index.php" form_data="*" src_ip="23.22.63.114" dest_ip="192.168.250.70"
| table _time src_ip, dest_ip, uri, form_data
| reverse`

Answer: 12345678

## Question 6: Web Defacement: What is the name of the executable uploaded by Po1s0n1vy? Please include the file extension. (For example, "notepad.exe" or "favicon.ico")

We know the attacker uploaded a file to the web server, where exactly is unknown and what filename was provided is also unknown, we know that its an executable file so we can look for the portable executable extension
.exe in the POST requests related to the target web server

Query: `index="botsv1" sourcetype="stream:http"  "*imreallynotbatman.com*" "*.exe*" http_method=POST  | table  _time, src_ip, dest_ip, request, uri, part_filename{}, content_disposition{}`

Screenshot: <img width="1914" height="919" alt="image" src="https://github.com/user-attachments/assets/ffc165c4-d2b0-4e4f-ba27-81e6d4804b98" />

Answer: 3791.exe

## Question 7: Web Defacement: What is the MD5 hash of the executable uploaded?
We know that the executable will have been executed in the context of the user configured on the web server, we know the server is a windows server. We can use the Sysmon logs to try and identify any commandline arguments including the executable in question, we can obtain the images hash from the fields available.

Query: `index="botsv1" sourcetype="xmlwineventlog" CommandLine="*3791.exe*" 
|  table ParentImage, ParentCommandLine, Image, CommandLine, Hashes`

Screenshot: <img width="1915" height="923" alt="image" src="https://github.com/user-attachments/assets/e028fc95-7209-4874-96d2-a56ae9ede3c2" />

With access to the hash of the executable it is always recommended to conduct a file reputation check uysing the hash in virustotal.

Screenshot: <img width="1913" height="923" alt="image" src="https://github.com/user-attachments/assets/81e8665b-7c2c-4eba-893d-0693e8898356" />

Straight away we can identify this executable as a trojan, with further static and dynamic analysis techniques conducted in a controlled environment we can determine the behaviour and objective of this malware
Answer: AAE3F5A29935E6ABCC2C2754D12A9AF0

## Question 8: Web Defacement: What was the correct password for admin access to the content management system running "imreallynotbatman.com"?
